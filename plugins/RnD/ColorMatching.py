""" Color matching plugin for ENLIGHTEN

    Allows the user to convert a visible spectrum into a color measurement

"""

import logging
import colour
import numpy as np
from EnlightenPlugin import EnlightenPluginBase
import textwrap
COLOR_PLUGIN_VERSION = "1.0.0"
log = logging.getLogger(__name__)

# Calibration for WP-00853 to yield flat spectral response
# This factor is generated by measuring a broadband light source
# with known spectral distribution and computed as follows:
# calibration_factor = measured_spectrum / true_spectrum
# Where true_spectrum is the ground truth for the spectrum.
# This factor will eventually be stored in spectrometer EEPROM, but
# is temporarily here for proof-of-concept purposes.

SPECTROMETER_CALIBRATION_FACTOR=[
65.48573141832215,
64.35944916921166,
62.05313114747805,
59.82349026411653,
59.695525554804874,
59.56516497520382,
58.43490683411545,
57.09652064535335,
56.0966039707963,
55.41245455269799,
55.07406270728888,
55.52796992167188,
56.02130193843949,
54.52105764726922,
53.107867046044646,
53.1680775235783,
53.679976974653606,
52.797887761917295,
50.71238961833378,
49.056581834160106,
48.146095128352414,
47.26964132151085,
46.94929933248912,
46.68514851098699,
46.013940179623795,
45.24880505131979,
44.43437794967077,
43.75979130828226,
43.090862553225165,
42.48357380293564,
41.90891673785777,
41.693780519310884,
41.5230101160634,
41.44504594383816,
41.492855631153176,
41.22496537988742,
40.5836406586592,
39.9142683757409,
39.126803323395926,
38.369430106222026,
38.1860710155072,
38.07262936453929,
38.05385242594301,
38.14343729538738,
38.11513337199164,
38.026801044611474,
37.91431517434785,
37.46596193217872,
37.004646649492734,
36.380336188368894,
35.73042627129186,
35.304650819456945,
35.17385533001091,
35.032867679298135,
34.792190975683454,
34.559599266786414,
34.45984232539109,
34.37169695467142,
34.438678741138276,
34.518061806400844,
34.54731524597029,
34.60371690484344,
34.58448120591621,
33.88560363816738,
33.17619029488823,
32.4565482794855,
31.864238944147804,
31.533874844892967,
31.480050095467227,
31.381711552634947,
30.88024618244272,
30.40264162504915,
30.345879574219953,
30.336816199967775,
29.994135932817628,
29.446883920829276,
29.000980575889038,
28.881272662868923,
28.734307047885547,
28.499006083560314,
28.238408967184533,
28.04110123768342,
27.84979135328874,
27.594016929339187,
27.17659450629594,
26.75830464392295,
26.477344038295037,
26.23058069397503,
25.963004614803047,
25.702452982359418,
25.419176720987696,
25.090136909160865,
24.839405727682365,
24.79229130004259,
24.752566938115507,
24.42658663133958,
24.05019758964326,
23.780309426343855,
23.721254302678748,
23.599113613256765,
23.323334446887966,
23.046450191269333,
22.819158983391596,
22.590173454503617,
22.456278075263363,
22.400098791579154,
22.288786169321654,
22.01667583063885,
21.744650117929194,
21.513092389886115,
21.2804922187835,
21.142734842761133,
21.09242053612609,
21.019713073101197,
20.777500682434024,
20.5387066021021,
20.34939546314693,
20.171655938786817,
19.97511073974029,
19.749404378549396,
19.56046025039635,
19.446332787203602,
19.316347923425372,
19.153296219886148,
18.99948488913952,
18.830843885129795,
18.67818679573201,
18.53252634562825,
18.395914389453498,
18.238904781018142,
18.032090474148816,
17.80557330786806,
17.733549701916573,
17.749381854364707,
17.702865073887256,
17.477006133053106,
17.240273116760886,
17.107481916095445,
17.00009039086704,
16.877242594581983,
16.73804291424402,
16.613948777032668,
16.486374214689768,
16.357845263292546,
16.31910144085941,
16.261189195657675,
16.149192746005834,
15.995610334217155,
15.861769079745995,
15.705702974100115,
15.56116341867267,
15.522951091459202,
15.507205270851845,
15.473612535828307,
15.35572816320354,
15.246339372674859,
15.188864024076631,
15.120496900366575,
15.026788906942691,
14.913246317781589,
14.808272127538713,
14.736047450975224,
14.66832251121299,
14.556770875142426,
14.431907103868562,
14.35988285297527,
14.291061065833874,
14.22507114871284,
14.166891974326154,
14.110305586781013,
14.04496169905611,
13.980271692880402,
13.905509281872925,
13.837826050865225,
13.75112382763912,
13.663406536478824,
13.577225411009191,
13.475846519671665,
13.360038651522697,
13.266322353111223,
13.200357199699276,
13.127890095929388,
13.027723923408674,
12.928075379462134,
12.837301855860998,
12.753050045040496,
12.68000144187523,
12.627941159945136,
12.56867974992115,
12.462907236775004,
12.344172961367294,
12.271809784967559,
12.252436639712887,
12.24659946090095,
12.130592777765123,
11.997672978128437,
11.942856309022257,
11.936175986217219,
11.891223250976047,
11.786530017766376,
11.667617402906371,
11.61676834289754,
11.575064677184397,
11.517911211763169,
11.404868711890495,
11.311458503982069,
11.286406776346816,
11.245065280350982,
11.195713500797156,
11.131502561435106,
11.062797433686773,
11.00800635726109,
10.944346165977082,
10.87939808450519,
10.821876135454902,
10.775354903260856,
10.72948109613399,
10.690117119768106,
10.588747222749442,
10.489971716150757,
10.45226174239402,
10.463416692955663,
10.45522548131286,
10.3342686643051,
10.221487538550713,
10.16983420171869,
10.144750864516,
10.098926065531007,
10.018370162763196,
9.93564515814304,
9.890038838956677,
9.836172422437938,
9.77988985511009,
9.724665787871778,
9.673998354923244,
9.667174319923035,
9.646740640560463,
9.592758210831686,
9.515071516792,
9.456705535461303,
9.425265911574602,
9.387393277706247,
9.346822060824287,
9.293984914529345,
9.25631546642248,
9.219202355499982,
9.191259385354275,
9.141683761986576,
9.09816763864764,
9.067524297716385,
9.035820211872402,
9.006593320321251,
8.962082607944104,
8.922990454230897,
8.889859199943183,
8.839381307207091,
8.794803915445046,
8.762244773001285,
8.734014233543116,
8.687643565649214,
8.644404974115327,
8.602031776940946,
8.57396740849528,
8.540946851729705,
8.509766787022395,
8.47927190570819,
8.456877974377532,
8.436007345187242,
8.408182129788532,
8.371891800687912,
8.333638419781664,
8.303487815461725,
8.27731081771699,
8.261504759833867,
8.22266658083445,
8.195211395991207,
8.161468592442105,
8.124609736008544,
8.101977523072412,
8.071325278833127,
8.039921166195656,
8.008553141134504,
7.978426535543608,
7.945416963758916,
7.906374017619324,
7.862506007148564,
7.833802801167947,
7.8165887732478385,
7.787556208734365,
7.757723432105792,
7.729136751434686,
7.702561562440755,
7.6744758819072825,
7.6482825228598506,
7.630777797350571,
7.611111682386902,
7.584263390528741,
7.551232256568025,
7.510297692769027,
7.463467870782528,
7.423177772212516,
7.387683431664364,
7.354358287057731,
7.313638773309204,
7.285129871459442,
7.2569031175892125,
7.230563299591123,
7.2062906055838365,
7.170794087339623,
7.128167682424089,
7.081930375096736,
7.040305636506161,
7.005602666513345,
6.973185571894539,
6.945335351807392,
6.915371072249035,
6.873367422304941,
6.8385381199484865,
6.805982055882519,
6.775369772576374,
6.738601669193051,
6.700444594090407,
6.660433023820562,
6.631883032059431,
6.608848018237581,
6.578103353049679,
6.5507659171230275,
6.525280033881334,
6.497426960141278,
6.470025513927447,
6.438146289788563,
6.405870889711786,
6.373135049740522,
6.345831480773683,
6.319187041257976,
6.297863615414466,
6.276075573004675,
6.254489185122091,
6.237544666261953,
6.222536526791516,
6.196293729842444,
6.1726708671955315,
6.155836902176763,
6.136293142846061,
6.120228228312267,
6.104375264075934,
6.08591178856265,
6.060157538218579,
6.039602655434794,
6.0147743047146,
5.9832577626265975,
5.949497817047806,
5.92675656165957,
5.910975474433453,
5.889300570463301,
5.861097984677282,
5.834080986953561,
5.799370157494007,
5.7690720233847985,
5.739836102407365,
5.711243103412432,
5.684694812391284,
5.658968334292457,
5.62426911708749,
5.598735813525127,
5.564911101926121,
5.532209347632821,
5.506415094988884,
5.476881846903026,
5.449874160233331,
5.434723295675923,
5.420479753244389,
5.399800046637671,
5.385839999503526,
5.36541462983688,
5.34834888998414,
5.331171775739321,
5.314221497791573,
5.295273483371839,
5.280215767035301,
5.26254268891416,
5.245148918560895,
5.231722544660797,
5.216056781169048,
5.195879860169252,
5.176958791489403,
5.154166050722939,
5.132065330236298,
5.113184470878608,
5.096234807401177,
5.072766330304556,
5.0505622090578655,
5.035318543982815,
5.016498993389345,
4.999341915336299,
4.976695957391604,
4.954526916197154,
4.9331862220565865,
4.917985830615725,
4.902522496342874,
4.881406417134092,
4.861192489345117,
4.843658719505153,
4.830391494833998,
4.823126651288862,
4.81433058991491,
4.799826075794472,
4.787165118471701,
4.766823878500899,
4.7475042064899835,
4.725724254291853,
4.704761202679052,
4.684925011315135,
4.6650492123753375,
4.646865263038936,
4.626720936628265,
4.596425341707576,
4.569206715975396,
4.5422850013584535,
4.522043249839872,
4.496356037661532,
4.481517255655792,
4.466042086263382,
4.457955188863436,
4.450908730477817,
4.443193016698049,
4.430034962856934,
4.422490763155152,
4.416819455933926,
4.4067911138150455,
4.392126978309423,
4.377840585628529,
4.3657336259504484,
4.357849863520129,
4.350239483662571,
4.34174491649509,
4.32766260494289,
4.3090262223790115,
4.286115327451218,
4.261901669195907,
4.236328760189891,
4.213497974210145,
4.1929494327180175,
4.177187708110652,
4.16218314907192,
4.1505506226073745,
4.130959571090074,
4.1149317620847,
4.0989719790926085,
4.089577368606145,
4.080030798055655,
4.070341894074725,
4.059744374846641,
4.045135830434662,
4.025306134832248,
4.010909836466192,
3.9927431804821105,
3.978225300025673,
3.965249676654333,
3.9558785068575273,
3.949521246933333,
3.939850311102682,
3.9311738827743006,
3.921766156464905,
3.9147113724109643,
3.902763080237914,
3.884431495453767,
3.8653935318855295,
3.8475467226154887,
3.832646599862494,
3.8181834131014987,
3.8015090220023993,
3.787381219373307,
3.7764662602469787,
3.768996840308897,
3.7567818413928755,
3.750335710742076,
3.7381230585825906,
3.7303682263348885,
3.7205312321920028,
3.7106192284837936,
3.704275967131406,
3.6944547198924798,
3.678605013628551,
3.659458830949945,
3.6398944922177763,
3.628301600790636,
3.6204588034442424,
3.6100354662211225,
3.593594186523505,
3.582909343780495,
3.577747410911261,
3.5721203455974253,
3.5653011743297065,
3.5539746804014096,
3.545633945768216,
3.5307447817289446,
3.522702074752299,
3.521886083022007,
3.5237396665283223,
3.5281598561942653,
3.528912198322747,
3.5209124557584666,
3.5087162693202294,
3.4927214501670902,
3.475801630952624,
3.460765982350157,
3.437641628461218,
3.413666346376489,
3.3899778233501037,
3.368079580771556,
3.3472944820119466,
3.328379036774166,
3.314179449951083,
3.307692785975561,
3.303539968771224,
3.306969266729182,
3.3071447290649356,
3.3035637481686906,
3.296142811764997,
3.2770430955088843,
3.254210524424692,
3.239064642513035,
3.2235956815333076,
3.211019480546235,
3.2047918248132685,
3.2041647869668743,
3.1989094345576303,
3.188377376337108,
3.169840409328534,
3.1434340343977563,
3.123787945963036,
3.1172343791799864,
3.118704198848804,
3.1154932833046165,
3.099044559631026,
3.082462743308586,
3.0819791965016727,
3.0971186684495664,
3.11505699043127,
3.122502689525848,
3.115802378246583,
3.0988252775711813,
3.0817491755400312,
3.0678801458431364,
3.045762842012441,
3.035609380878853,
3.034566781560065,
3.041692855237422,
3.0572827076291618,
3.0643948829199155,
3.0463628006261887,
3.0342498414247427,
3.0072752406511674,
2.9716873737896643,
2.9473104391384983,
2.9373446648335517,
2.94297081200083,
2.952462700656833,
2.9524283269747884,
2.9423208469944826,
2.931174191943336,
2.9128474919909113,
2.889177997928906,
2.858731106436714,
2.834835812122118,
2.825853878041155,
2.8272698999702883,
2.8250608400611803,
2.816229538243129,
2.8002713183119456,
2.7834049375674157,
2.7724221621208347,
2.766617215477735,
2.7611936510622743,
2.7531285368788585,
2.745994133957532,
2.7393249678355356,
2.7416198658277673,
2.7446670252079204,
2.7581049120179726,
2.777534846388277,
2.7775796255072263,
2.7634020234472465,
2.744695904518108,
2.729859389100271,
2.711266708378305,
2.702471111608619,
2.7009614645458826,
2.6961446912096307,
2.677961357565061,
2.650904713847606,
2.6300144880159197,
2.6223850219614944,
2.622610696804907,
2.6272954378294044,
2.6419126136671545,
2.6447333301185574,
2.641796200448296,
2.637264582732034,
2.630993703116924,
2.6213331296015796,
2.606962768550324,
2.591395514116359,
2.5813889179660183,
2.5830789193193158,
2.5876546757844943,
2.5874491579149383,
2.5857389100165054,
2.5825378464351494,
2.5741803503684015,
2.562257004377962,
2.5558758418844922,
2.5514972699433716,
2.552408098211726,
2.5433619707081236,
2.5347377942478504,
2.525993703848954,
2.5191864326287425,
2.5192459356703845,
2.5202857233824987,
2.518935735693452,
2.5113565927460644,
2.4961063582220557,
2.4807802687608267,
2.470359586797318,
2.4663082124539923,
2.4665531787239754,
2.4658134487409327,
2.465138312885603,
2.459816364455709,
2.451657059221701,
2.446174308532527,
2.4424360871232405,
2.439121860039392,
2.435505469728266,
2.432285543001771,
2.4293177660802807,
2.430968387717002,
2.430363883610234,
2.4294456006147733,
2.4274427827962497,
2.422215738662317,
2.4149522356863242,
2.4076509574546505,
2.4033367341988834,
2.3979656228882833,
2.3919536225063722,
2.3875789356672135,
2.379130397254504,
2.3708264173986096,
2.3661501809853016,
2.358501111554638,
2.351291185490571,
2.3424283193190605,
2.341214769602916,
2.3413727695964903,
2.3399558025073284,
2.338897482370214,
2.338588071308636,
2.3365002248011573,
2.3358546134123634,
2.3358472250616975,
2.3306680537300704,
2.3235766127667037,
2.3167142410304904,
2.3081758818904077,
2.300001221747812,
2.293474718288753,
2.285700990676148,
2.276439821971285,
2.268747667398115,
2.2637649720333135,
2.2582875070398627,
2.255259344496919,
2.2511146012025485,
2.248001735867042,
2.2450889039364195,
2.2413649253214762,
2.236095455674934,
2.2320993412245227,
2.2274668895165566,
2.2217930656050267,
2.216928379128443,
2.209448846196368,
2.2011985099374374,
2.197912720597385,
2.1934791969856144,
2.189447629340396,
2.183801964343826,
2.179183099419187,
2.173861935655192,
2.167279816874898,
2.16091664202121,
2.1573627358901604,
2.151483245317182,
2.1453041765126835,
2.1397707171714297,
2.1338907339322555,
2.128239566272208,
2.123729808104557,
2.120287335046792,
2.115788545862644,
2.1102660091545027,
2.1019681788418256,
2.094846221656159,
2.0908641639119114,
2.086490124455975,
2.083067232110483,
2.0772763047922838,
2.0692132662615697,
2.0645808752791877,
2.062595073135405,
2.061400142498942,
2.0570363032251824,
2.051520820164096,
2.0489178495727667,
2.0474907891732537,
2.0475360798595803,
2.0441261197061245,
2.038311479938277,
2.0336465849058367,
2.030868613338473,
2.027108041612738,
2.020907838994342,
2.0157663548667957,
2.0124660602107314,
2.0059794392577825,
1.9997172208982792,
1.9967892957320084,
1.995849594370518,
1.9933571855255823,
1.9903266701464788,
1.986427060303371,
1.9825565192361867,
1.978727590734313,
1.976433112294884,
1.9723761274834473,
1.969426765180196,
1.9687107407005093,
1.9668724414646184,
1.964716583855853,
1.9619803585309288,
1.958856588349469,
1.9564358061094502,
1.952214833901997,
1.9473059256582945,
1.9437183706619672,
1.942319457773378,
1.943458107287884,
1.9429480403391308,
1.9391009383155784,
1.9359901669509834,
1.93417946583908,
1.934530382225218,
1.9299182035030125,
1.9270915267532258,
1.9205971849203893,
1.9160161503047282,
1.9117340899208755,
1.9089105579042722,
1.9054094995031146,
1.902283566354377,
1.8998564008097576,
1.8944777605386605,
1.891792573895766,
1.8878593744246335,
1.880762978433385,
1.8759272880956008,
1.874504244042097,
1.8711044340662495,
1.8701251408046855,
1.8680683919818182,
1.865379092801503,
1.8630148976503245,
1.8636987598985018,
1.861970202813189,
1.8615009074589957,
1.8594946126747096,
1.8566383079157704,
1.8556142612744664,
1.8542303826179083,
1.8513938121693847,
1.8465572354194522,
1.8433965386877236,
1.8407684342328092,
1.8374556744880028,
1.834754843279064,
1.8320222441388625,
1.8299254648725694,
1.8276231506644491,
1.8260818033586648,
1.8242323076401674,
1.8222735913673331,
1.8193173247615888,
1.8183814007797605,
1.8166023934567213,
1.8140097257483938,
1.80972948243546,
1.805895736477832,
1.8023056033641511,
1.798740886455431,
1.7968558376774562,
1.7929806645316515,
1.790672791800546,
1.7875974711840974,
1.784527018306923,
1.7826206207727147,
1.7791590249309286,
1.7749380172081117,
1.7716091636442655,
1.76920660161995,
1.7683157841484227,
1.7684702048700898,
1.7650058571852072,
1.763924052907428,
1.7639317115452293,
1.7610239276188036,
1.7572249886908382,
1.7538003210656614,
1.7495579527459042,
1.7472160653338298,
1.7439616533039395,
1.741076569989778,
1.7388686427649915,
1.7357524311222416,
1.7337241847085076,
1.729733958344343,
1.7272908484049947,
1.7263751655564918,
1.7247908058907737,
1.7235460359505625,
1.717875146025108,
1.7148333999793697,
1.7097011528419026,
1.7075201881795028,
1.706290176619333,
1.7017729403081685,
1.6977855589593247,
1.693348743030256,
1.6888699003186398,
1.6840491876211867,
1.68061738549268,
1.679530935905512,
1.6786002489756595,
1.6749927761093677,
1.6710425605557773,
1.6664752760013837,
1.663171607939686,
1.6595353943379658,
1.6562735272374762,
1.6528158696237054,
1.6484073084873392,
1.6419570654058595,
1.6352374796065936,
1.6321739274044196,
1.6289449167707395,
1.6256739273230691,
1.6226403105583997,
1.6212106681281264,
1.6194379655422315,
1.6160226350343674,
1.614275218793525,
1.6099985753793409,
1.6054864362906849,
1.6003399552353135,
1.599363023566355,
1.597189741390396,
1.5934140071249303,
1.5900905949468829,
1.5857876852355504,
1.5819994713961294,
1.5791639648466946,
1.5753638071633245,
1.573367480849718,
1.5686782171662528,
1.5640303456392992,
1.56071634909173,
1.5581765184502236,
1.5538365128053875,
1.548447891521716,
1.5452262414302806,
1.541238999969357,
1.5392671310667512,
1.5357418377273633,
1.5298338411253134,
1.525057498762237,
1.520050293489224,
1.5148610300512493,
1.5092616719466734,
1.502158119852904,
1.4975861538273614,
1.4926991403548646,
1.4881787007634568,
1.482539146802317,
1.4759161047179394,
1.4694597406774133,
1.4640745308619767,
1.4600259007308556,
1.4551554904419473,
1.4487699130674183,
1.4429454422088765,
1.4356626609467742,
1.4283135748479714,
1.4221174206706533,
1.419088123941108,
1.4151713096601313,
1.4104479227564815,
1.4067959767890836,
1.4014983138828738,
1.395993977947625,
1.389172656234708,
1.3843633987559076,
1.3822994163135525,
1.380050005073384,
1.3751007814080232,
1.3698199160412685,
1.3640398945807293,
1.3605436252334573,
1.3581173312519927,
1.3544017329241291,
1.3511295028754058,
1.3465049081285416,
1.340691515616876,
1.3356299458326444,
1.3295617992959077,
1.3242991054105424,
1.3200322834911262,
1.3140546070289025,
1.3071294971525622,
1.3015762174900993,
1.2975397026719684,
1.2934101921406413,
1.2886980785981745,
1.2815329778533298,
1.2734617985706767,
1.2672495792301905,
1.262931337395203,
1.259342189598978,
1.2541017333242235,
1.2498233752050452,
1.244333501162457,
1.2380405990846748,
1.2336646582295137,
1.2285778331609305,
1.2236890494328747,
1.2189851928081863,
1.2148886487089845,
1.2100926055932593,
1.2061927872808689,
1.2012160148978583,
1.1966270196928963,
1.1934182112927403,
1.1894843871161496,
1.18691129180388,
1.1817266109898317,
1.1771971151932985,
1.171951828608877,
1.1687693899168676,
1.1653828661634056,
1.1604564715871872,
1.1548246709644936,
1.149074358917443,
1.1449900200144665,
1.1411367431756856,
1.137165339120491,
1.1334915035920181,
1.1295277881013972,
1.1236953226007347,
1.117965017127736,
1.1139606116762628,
1.1094983984052793,
1.1057409663557298,
1.1004019324718592,
1.0955315423518355,
1.0908357175119239,
1.0867681742474617,
1.083122871200466,
1.0803253835179827,
1.0758685220581483,
1.072356266518207,
1.068748191916973,
1.0662567091794002,
1.0617036629873295,
1.0575073917563091,
1.0530128051819863,
1.0515231246620327,
1.0476167496599287,
1.0424254862532176,
1.0370809071509972,
1.0323910890637593,
1.0275159450764026,
1.0236921175914593,
1.0186568605893738,
1.0139075888384232,
1.009764023356815,
1.0047800783549203,
1.0004232702016043,
0.9971810499390729,
0.9937981609657843,
0.9904688959515542,
0.9877438709970183,
0.9844661017971743,
0.9814705627505018,
0.9790350032025117,
0.9748246503023107,
0.9699679481860232,
0.9653797146884857,
0.9610494990987312,
0.9577422129174501,
0.9550275898592997,
0.9537206700881192,
0.9497303904062503,
0.9442702682104231,
0.9412257015518758,
0.938391189457947,
0.9357202016619977,
0.9326190350739556,
0.9300196714424732,
0.927444559208246,
0.9252602575622887,
0.9229621052048547,
0.9171357616783294,
0.9120024753827068,
]

COLOR_MODEL_ALIASES = {
                        'CIE 1931 2 deg' : 'CIE 1931 2 Degree Standard Observer',
                        'CIE 1931 10 deg' : 'CIE 1964 10 Degree Standard Observer',
                        'CIE 2015 2 deg' : 'CIE 2015 2 Degree Standard Observer',
                        'CIE 2015 10 deg' : 'CIE 2015 10 Degree Standard Observer'
}

class ColorMatching(EnlightenPluginBase):

        def disconnect(self):
            super().disconnect()

        def get_configuration(self):

            self.name = f"ColorMatching {COLOR_PLUGIN_VERSION}"
            self.has_other_graph = False
            self.auto_enable = True
            self.is_blocking = True
            self.block_enlighten = False

            self.field(
                name="Color Model",
                datatype="combobox",
                direction="input",
                choices=list(COLOR_MODEL_ALIASES.keys()),
                tooltip="Color model to use",
            )

            self.field(
                name="XYZ",
                datatype=str,
                direction="output",
                tooltip="XYZ",
            )

            self.field(
                name="RGB",
                datatype=str,
                direction="output",
                tooltip="RGB",
            )

            self.field(
                name="sRGB",
                datatype=str,
                direction="output",
                tooltip="sRGB",
            )

            self.field(
                name="Color Temp",
                datatype=str,
                direction="output",
                tooltip="Color temperature",
            )

            self.field(name="Apply Calibration",
                       direction="input",
                       datatype=bool,
                       initial=True,
                       expert=False,
                       tooltip="Apply hard coded (relative) spectral intensity calibration")

            log.debug(f"{self.name} started")

        def process_request(self, request):
            """ Process new spectrum received from ENLIGHTEN

                Spectra are divided by a hard-coded calibration factor (if enabled) to give a flat spectral response,
                interpolated to 1 nm wavelength spacing (necessary for the color-science package), then converted
                into CIE XYZ tristimulus values.

                CIE XYZ is the necessary basis for conversion to other colorspaces.

                The function demonstrates conversion to sRGB, RGB and color temperature.

            """
            wavelength = np.array(self.settings.wavelengths, dtype=np.float64)
            spectrum = np.array(request.processed_reading.processed, dtype=np.float64)

            colorspace_alias = request.fields["Color Model"]
            colorspace_model = COLOR_MODEL_ALIASES[colorspace_alias]
            apply_calibration = request.fields["Apply Calibration"]

            if apply_calibration:
                spectrum = spectrum / SPECTROMETER_CALIBRATION_FACTOR

            wavelength_interp = np.arange(int(min(wavelength)), int(max(wavelength))+1, 1)
            spectral_interp = np.interp(wavelength_interp, wavelength,spectrum)

            spectral_data = {w: c for w, c in zip(wavelength_interp, spectral_interp)}

            sd = colour.SpectralDistribution(spectral_data)
            cmfs = colour.MSDS_CMFS[colorspace_model]

            XYZ = colour.sd_to_XYZ(sd, cmfs)

            RGB = colour.XYZ_to_RGB(XYZ, 'CIE RGB')
            sRGB = colour.XYZ_to_sRGB(XYZ)
            xy = colour.XYZ_to_xy(XYZ)
            cct = colour.xy_to_CCT(xy)

            XYZ_n = (XYZ/max(XYZ))
            RGB_n = (RGB/max(RGB))*100
            sRGB_n = (sRGB/max(sRGB))*255

            self.outputs = {
                "XYZ": f"{XYZ_n[0]:.2f}, {XYZ_n[1]:.2f}, {XYZ_n[2]:.2f}",
                "RGB": f"{RGB_n[0]:.2f}, {RGB_n[1]:.2f}, {RGB_n[2]:.2f}",
                "sRGB": f"{sRGB_n[0]:.2f}, {sRGB_n[1]:.2f}, {sRGB_n[2]:.2f}",
                "Color Temp": f"{cct:.1f} K"
            }

            if apply_calibration:
                self.plot(x=wavelength_interp,
                          y=spectral_interp,
                          title=f"Calibrated",
                          color='#2994d3')